<!doctype html>
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{fragments :: head('Restock Request')}"></head>
<body>

<div th:replace="~{fragments :: nav}"></div>

<div class="container py-4" style="max-width:900px;">
  <h1 class="h3 section-title mb-3">
    <i class="bi bi-truck me-2"></i>Restock Request
  </h1>

  <div class="card">
    <div class="card-body">

      <!-- ===========================
           EDIT MODE (Single POST form)
           =========================== -->
      <div th:if="${isEdit}">
        <form th:action="${isEdit} ? @{/staff/restock/{id}(id=${req.id})} : @{/staff/restock}"
              method="post"
              th:object="${req}"
              class="row g-3">

          <!-- Hidden fields -->
          <input type="hidden" th:if="${isEdit}" th:field="*{id}"/>
          <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>

          <!-- Vendor -->
          <div class="col-md-6">
            <label class="form-label">Vendor</label>
            <select class="form-select" th:field="*{vendorId}" required>
              <option value="" disabled>Select vendor</option>
              <!-- Support both v.id and v.vendorId -->
              <option th:each="v : ${vendors}"
                      th:value="${v.vendorId != null ? v.vendorId : v.id}"
                      th:text="${v.name}">
              </option>
            </select>
            <div class="invalid-feedback d-block"
                 th:if="${#fields.hasErrors('vendorId')}" th:errors="*{vendorId}">Error</div>
          </div>

          <!-- Product -->
          <div class="col-md-6">
            <label class="form-label">Product (Low on stock)</label>
            <select class="form-select"
                    th:field="*{productId}"
                    th:disabled="${#lists.isEmpty(products)}"
                    required>
              <option value="" disabled th:selected="*{productId} == null">Select product</option>
              <!-- Support both p.id and p.productId -->
              <option th:each="p : ${products}"
                      th:value="${p.productId != null ? p.productId : p.id}"
                      th:text="${p.brand + ' ' + p.name + ' [' + p.skuId + ']'}">
              </option>
            </select>
            <div class="invalid-feedback d-block"
                 th:if="${#fields.hasErrors('productId')}" th:errors="*{productId}">Error</div>
            <div class="form-text" th:if="${#lists.isEmpty(products)}">
              No products available for the selected vendor.
            </div>
          </div>

          <!-- Quantity -->
          <div class="col-md-4">
            <label class="form-label">Requested Quantity</label>
            <input class="form-control" type="number" min="1" th:field="*{requestedQty}" placeholder="10" required/>
            <div class="invalid-feedback d-block"
                 th:if="${#fields.hasErrors('requestedQty')}" th:errors="*{requestedQty}">Error</div>
          </div>

          <!-- Actions -->
          <div class="col-12 d-flex gap-2">
            <button class="btn btn-primary" type="submit">
              <i class="bi bi-save me-1"></i>
              <span th:text="${isEdit} ? 'Update' : 'Submit Request'">Update</span>
            </button>
            <a class="btn btn-outline-secondary" th:href="@{/dashboard}">
              <i class="bi bi-x-circle me-1"></i>Cancel
            </a>
          </div>
        </form>
      </div>

      <!-- ===========================
           CREATE MODE (GET + POST)
           =========================== -->
      <div th:if="${!isEdit}">
        <!-- Vendor selector (GET) -->
        <form th:action="@{/staff/restock/new}" method="get" id="vendorForm" class="mb-3">
          <label class="form-label">Vendor</label>
          <select class="form-select" name="vendorId"
                  th:value="${selectedVendorId}"
                  onchange="document.getElementById('vendorForm').submit()" required>

            <option value="" disabled th:selected="${selectedVendorId == null}">Select vendor</option>

            <option th:each="v : ${vendors}"
                    th:value="${v.vendorId != null ? v.vendorId : v.id}"
                    th:selected="${selectedVendorId != null and ( (v.vendorId != null ? v.vendorId : v.id) == selectedVendorId )}"
                    th:text="${v.name}">
            </option>
          </select>
        </form>

        <!-- Create restock (POST) -->
        <form th:action="@{/staff/restock}" method="post" th:object="${req}" class="row g-3">
          <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />

          <!-- Ensure the vendor id is posted -->
          <!-- Option A: independent hidden field based on selectedVendorId -->
          <input type="hidden" name="vendorId" th:value="${selectedVendorId}" />
          <!-- Option B: if controller prefilled req.vendorId, you can use strong binding instead -->
          <!-- <input type="hidden" th:field="*{vendorId}" /> -->

          <!-- Product -->
          <div class="col-md-6">
            <label class="form-label">Product (Low on stock)</label>
            <select class="form-select"
                    th:field="*{productId}"
                    th:disabled="${#lists.isEmpty(products)}"
                    required>
              <option value="" disabled th:selected="*{productId} == null">Select product</option>
              <option th:each="p : ${products}"
                      th:value="${p.productId != null ? p.productId : p.id}"
                      th:text="${p.brand + ' ' + p.name + ' [' + p.skuId + ']'}">
              </option>
            </select>
            <div class="invalid-feedback d-block"
                 th:if="${#fields.hasErrors('productId')}" th:errors="*{productId}">Error</div>
            <div class="form-text" th:if="${#lists.isEmpty(products)} and ${selectedVendorId != null}">
              No products found for the selected vendor.
            </div>
          </div>

          <!-- Quantity -->
          <div class="col-md-4">
            <label class="form-label">Requested Quantity</label>
            <input class="form-control" type="number" min="1" th:field="*{requestedQty}" required />
            <div class="invalid-feedback d-block"
                 th:if="${#fields.hasErrors('requestedQty')}" th:errors="*{requestedQty}">Error</div>
          </div>

          <!-- Actions -->
          <div class="col-12 d-flex gap-2">
            <button class="btn btn-primary" type="submit" th:disabled="${selectedVendorId == null}">
              Submit Request
            </button>
            <a class="btn btn-outline-secondary" th:href="@{/dashboard}">Cancel</a>
          </div>
        </form>
      </div>

    </div>
  </div>

  <div class="alert alert-info mt-3">
    Choose the vendor and the item thatâ€™s running out of stock. Requests are saved as <b>PENDING</b>.
  </div>
</div>

</body>
</html>