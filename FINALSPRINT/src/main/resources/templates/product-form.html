<!doctype html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">

<head th:replace="~{fragments :: head(${product != null && product.productId != null ? 'Edit Product' : 'Add Product'})}"></head>

<body>

<div th:replace="~{fragments :: nav}"></div>

<div class="container py-4" style="max-width: 860px;">

    <h1 class="h4 mb-3">
        <i class="bi bi-plus-circle me-2"></i>
        <span th:text="${product != null && product.productId != null ? 'Edit Product' : 'Add Product'}">Add Product</span>
    </h1>

    <!-- Flash Messages -->
    <div th:if="${success}" class="alert alert-success" th:text="${success}"></div>
    <div th:if="${error}" class="alert alert-danger" th:text="${error}"></div>

    <div class="card">
        <div class="card-body">

            <!-- MAIN FORM - Fixed opening tag and th:action syntax -->
            <form th:action="${product != null && product.productId != null} ? @{'/products/' + ${product.productId}} : @{'/products'}"
                  th:object="${product}"
                  method="post"
                  class="row g-3">

                <!-- In EDIT mode: override POST -> PUT -->
                <input type="hidden" name="_method" value="put" th:if="${product != null && product.productId != null}"/>

                <!-- CSRF (Spring Security automatically handles this if using th:action, but explicit is fine) -->
                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>

                <!-- Product ID -->
                <input type="hidden" th:if="*{productId != null}" th:field="*{productId}"/>

                <!-- SKU -->
                <div class="col-md-6">
                    <label class="form-label">SKU</label>
                    <input type="text" class="form-control" th:field="*{skuId}" placeholder="SKU-EL-0001" required>
                    <div class="invalid-feedback d-block" th:if="${#fields.hasErrors('skuId')}" th:errors="*{skuId}"></div>
                </div>

                <!-- Brand -->
                <div class="col-md-6">
                    <label class="form-label">Brand</label>
                    <input type="text" class="form-control" th:field="*{brand}" placeholder="Aether" required>
                    <div class="invalid-feedback d-block" th:if="${#fields.hasErrors('brand')}" th:errors="*{brand}"></div>
                </div>

                <!-- Name -->
                <div class="col-12">
                    <label class="form-label">Name</label>
                    <input type="text" class="form-control" th:field="*{name}" placeholder="Phone 314" required>
                    <div class="invalid-feedback d-block" th:if="${#fields.hasErrors('name')}" th:errors="*{name}"></div>
                </div>

                <!-- Price -->
                <div class="col-md-4">
                    <label class="form-label">Price</label>
                    <input type="number" class="form-control" th:field="*{price}" min="0" step="0.01" required>
                    <div class="invalid-feedback d-block" th:if="${#fields.hasErrors('price')}" th:errors="*{price}"></div>
                </div>

                <!-- Stock Qty -->
                <div class="col-md-4">
                    <label class="form-label">Stock Qty</label>
                    <input type="number" class="form-control" th:field="*{stockQty}" min="0" step="1" required>
                    <div class="invalid-feedback d-block" th:if="${#fields.hasErrors('stockQty')}" th:errors="*{stockQty}"></div>
                </div>

                <!-- Vendor dropdown -->
                <div class="col-md-4">
                    <label class="form-label">Vendor</label>
                    <select class="form-select" th:field="*{vendorId}" required>
                        <option th:value="${null}">Select vendor</option>
                        <option th:each="v : ${vendors}"
                                th:value="${v.vendorId}"
                                th:text="${v.name}">
                        </option>
                    </select>
                    <div class="invalid-feedback d-block" th:if="${#fields.hasErrors('vendorId')}" th:errors="*{vendorId}"></div>
                </div>

                <!-- Hidden categoryId -->
                <input type="hidden" name="categoryId" th:value="${categoryId}"/>

                <!-- Action Buttons -->
                <div class="mt-3 d-flex gap-2">
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-save me-1"></i>
                        <span th:text="${product != null && product.productId != null ? 'Update' : 'Save'}">Save</span>
                    </button>

                    <!-- Fixed Cancel Link opening tag -->
                    <a th:href="@{/categories/{id}(id=${categoryId})}" class="btn btn-secondary">
                        <i class="bi bi-x-circle me-1"></i>Cancel
                    </a>
                </div>

                <div class="mt-3 alert alert-info mb-0">
                    After saving, you will be redirected back to the category page.
                </div>

            </form>

        </div>
    </div>
</div>
</body>
</html>
