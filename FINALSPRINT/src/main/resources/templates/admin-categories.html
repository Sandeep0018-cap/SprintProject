<!doctype html>
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{fragments :: head('Admin Categories')}"></head>
<body>
<div th:replace="~{fragments :: nav}"></div>

<div class="container py-4" style="max-width:900px;">
  <h1 class="h3 section-title mb-3">
    <i class="bi bi-collection me-2"></i>Admin: Categories
  </h1>

  <div th:if="${msg}" class="alert alert-success" th:text="${msg}"></div>
  <div th:if="${err}" class="alert alert-danger" th:text="${err}"></div>

  <!-- Create Category -->
  <div class="card mb-3">
    <div class="card-body">
      <form th:action="@{/admin/categories}" method="post" class="row g-2 align-items-end">
        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
        <div class="col-md-9">
          <label class="form-label">New category name</label>
          <input class="form-control" name="name" placeholder="New category name" required/>
        </div>
        <div class="col-md-3 d-grid">
          <button class="btn btn-primary" type="submit">
            <i class="bi bi-plus-circle me-1"></i>Add Category
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- List Categories -->
  <div class="card">
    <div class="table-responsive">
      <table class="table table-hover align-middle mb-0">
        <thead class="table-light">
          <tr><th>ID</th><th>Name</th><th class="text-end">Actions</th></tr>
        </thead>
        <tbody>
          <tr th:each="c : ${categories}">
            <td class="small text-muted" th:text="${c.categoryId}">1</td>
            <td class="fw-semibold" th:text="${c.name}">Name</td>
            <td class="text-end">
              <!-- Edit -->
              <button type="button"
                      class="btn btn-sm btn-outline-primary"
                      data-bs-toggle="modal"
                      data-bs-target="#editCategoryModal"
                      th:attr="data-id=${c.categoryId}, data-name=${c.name}">
                <i class="bi bi-pencil-square me-1"></i>Edit
              </button>

              <!-- Delete -->
              <form th:action="@{/admin/categories/{id}/delete(id=${c.categoryId})}"
                    method="post" class="d-inline">
                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                <button class="btn btn-sm btn-outline-danger" type="submit"
                        onclick="return confirm('Delete category?')">
                  <i class="bi bi-trash3 me-1"></i>Delete
                </button>
              </form>

          <tr th:if="${#lists.isEmpty(categories)}">
            <td colspan="3" class="text-center text-muted py-3">No categories</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

</div>

<!-- =========================
     Edit Category Modal
     ========================= -->
<div class="modal fade" id="editCategoryModal" tabindex="-1" aria-labelledby="editCategoryModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 id="editCategoryModalLabel" class="modal-title">
          <i class="bi bi-pencil-square me-2"></i>Edit Category
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <form id="editCategoryForm" method="post">
        <div class="modal-body">
          <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>

          <div class="mb-3">
            <label class="form-label">Category Name</label>
            <input id="editCategoryName" class="form-control" name="name" required/>
          </div>
        </div>

        <div class="modal-footer">
          <button class="btn btn-secondary" type="button" data-bs-dismiss="modal">Cancel</button>
          <button class="btn btn-primary" type="submit">
            <i class="bi bi-save me-1"></i>Save Changes
          </button>
        </div>
      </form>

    </div>
  </div>
</div>

<!-- Bootstrap JS (needed for dropdowns & modals) -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
  // Wire the Edit Category modal with the row data & dynamic form action
  const editCategoryModal = document.getElementById('editCategoryModal');
  editCategoryModal?.addEventListener('show.bs.modal', (event) => {
    const button = event.relatedTarget;
    const id = button.getAttribute('data-id');
    const name = button.getAttribute('data-name');

    const form = document.getElementById('editCategoryForm');
    const nameInput = document.getElementById('editCategoryName');

    // Set form action to POST /admin/categories/{id}/edit
    form.action = `/admin/categories/${id}/edit`;
    nameInput.value = name ?? '';
  });
</script>

</body>
</html>