<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ProductServiceImpl.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">SprintDB Order Inventory System</a> &gt; <a href="index.source.html" class="el_package">com.cg.service.impl</a> &gt; <span class="el_source">ProductServiceImpl.java</span></div><h1>ProductServiceImpl.java</h1><pre class="source lang-java linenums">package com.cg.service.impl;

import com.cg.dto.ProductDto;
import com.cg.dto.ProductStockAlertDto;
import com.cg.entity.*;
import com.cg.exception.ResourceNotFoundException;
import com.cg.repository.*;
import com.cg.service.IProductService;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;
import java.util.*;
import java.util.stream.Collectors;

@Service
public class ProductServiceImpl implements IProductService {
    
    private final ProductRepository productRepository;
    private final CategoryRepository categoryRepository;
    private final PurchaseItemRepository purchaseItemRepository;
    private final VendorRepository vendorRepository;

    public ProductServiceImpl(ProductRepository productRepository,
                              CategoryRepository categoryRepository,
                              PurchaseItemRepository purchaseItemRepository,
<span class="fc" id="L25">                              VendorRepository vendorRepository) {</span>
<span class="fc" id="L26">        this.productRepository = productRepository;</span>
<span class="fc" id="L27">        this.categoryRepository = categoryRepository;</span>
<span class="fc" id="L28">        this.purchaseItemRepository = purchaseItemRepository;</span>
<span class="fc" id="L29">        this.vendorRepository = vendorRepository;</span>
<span class="fc" id="L30">    }</span>

    @Override
    @Transactional // Orchestrates the full save/update cycle including automated vendor assignment
    public ProductDto createOrUpdate(ProductDto dto, Long categoryId) {
<span class="fc" id="L35">        Category category = categoryRepository.findById(categoryId)</span>
<span class="fc" id="L36">                .orElseThrow(() -&gt; new ResourceNotFoundException(&quot;Category not found: &quot; + categoryId));</span>

<span class="pc bpc" id="L38" title="1 of 2 branches missed.">        Product p = (dto.getProductId() == null) ? new Product() </span>
<span class="fc" id="L39">                : productRepository.findById(dto.getProductId())</span>
<span class="fc" id="L40">                .orElseThrow(() -&gt; new ResourceNotFoundException(&quot;Product not found: &quot; + dto.getProductId()));</span>

<span class="fc" id="L42">        p.setSkuId(dto.getSkuId());</span>
<span class="fc" id="L43">        p.setName(dto.getName());</span>
<span class="fc" id="L44">        p.setBrand(dto.getBrand());</span>
<span class="pc bpc" id="L45" title="1 of 2 branches missed.">        p.setPrice(dto.getPrice() == null ? 0.0 : dto.getPrice());</span>
<span class="pc bpc" id="L46" title="1 of 2 branches missed.">        p.setStockQty(dto.getStockQty() == null ? 0 : dto.getStockQty());</span>
<span class="fc" id="L47">        p.setCategory(category);</span>

        // Fallback logic: Assigns the first available vendor if no specific ID is provided
<span class="pc bpc" id="L50" title="1 of 2 branches missed.">        Vendor vendor = (dto.getVendorId() == null) </span>
<span class="nc" id="L51">                ? vendorRepository.findFirstByOrderByVendorIdAsc().orElseThrow(() -&gt; new IllegalStateException(&quot;No vendors available&quot;))</span>
<span class="fc" id="L52">                : vendorRepository.findById(dto.getVendorId()).orElseThrow(() -&gt; new ResourceNotFoundException(&quot;Vendor not found&quot;));</span>
<span class="fc" id="L53">        p.setVendor(vendor);</span>

<span class="fc" id="L55">        Product saved = productRepository.save(p);</span>
<span class="fc" id="L56">        return mapToDtoWithStats(saved); // Internal helper to attach calculated inventory metrics</span>
    }

    @Override
    @Transactional(readOnly = true) // Optimized for read-only access during form pre-population
    public ProductDto getByIdAsDto(Long id) {
<span class="nc" id="L62">        Product p = productRepository.findById(id)</span>
<span class="nc" id="L63">                .orElseThrow(() -&gt; new ResourceNotFoundException(&quot;Product not found: &quot; + id));</span>
<span class="nc" id="L64">        return mapToDtoWithStats(p);</span>
    }

    @Override
    @Transactional // Ensures cascading effects are handled during record removal
    public void delete(Long id) {
<span class="nc bnc" id="L70" title="All 2 branches missed.">        if (!productRepository.existsById(id)) throw new ResourceNotFoundException(&quot;Product not found&quot;);</span>
<span class="nc" id="L71">        productRepository.deleteById(id);</span>
<span class="nc" id="L72">    }</span>

    @Override
    @Transactional(readOnly = true) // Bulk calculation of sales and availability for the category view
    public List&lt;ProductDto&gt; findByCategoryWithDerivedStats(Long categoryId) {
<span class="nc" id="L77">        List&lt;Product&gt; products = productRepository.findByCategoryCategoryIdOrderByBrandAscNameAsc(categoryId);</span>
<span class="nc bnc" id="L78" title="All 2 branches missed.">        if (products.isEmpty()) return Collections.emptyList();</span>

<span class="nc" id="L80">        List&lt;Long&gt; ids = products.stream().map(Product::getProductId).collect(Collectors.toList());</span>
<span class="nc" id="L81">        List&lt;PurchaseItem&gt; items = purchaseItemRepository.findByProductProductIdIn(ids);</span>

        // Maps calculated sales volumes and latest purchase references to product IDs
<span class="nc" id="L84">        Map&lt;Long, Integer&gt; soldMap = items.stream().collect(Collectors.groupingBy(pi -&gt; pi.getProduct().getProductId(), Collectors.summingInt(PurchaseItem::getQuantity)));</span>
<span class="nc" id="L85">        Map&lt;Long, Long&gt; lastPurchaseMap = items.stream().collect(Collectors.toMap(pi -&gt; pi.getProduct().getProductId(), pi -&gt; pi.getPurchase().getId(), (a, b) -&gt; Math.max(a, b)));</span>

<span class="nc" id="L87">        return products.stream().map(p -&gt; {</span>
<span class="nc" id="L88">            ProductDto d = mapToDtoWithStats(p, soldMap.getOrDefault(p.getProductId(), 0));</span>
<span class="nc" id="L89">            d.setLastPurchaseId(lastPurchaseMap.get(p.getProductId()));</span>
<span class="nc" id="L90">            return d;</span>
<span class="nc" id="L91">        }).collect(Collectors.toList());</span>
    }

    @Override
    public Map&lt;String, List&lt;ProductDto&gt;&gt; groupByBrand(List&lt;ProductDto&gt; products) {
        // Groups the list into a LinkedHashMap to preserve the brand's alphabetical sort order
<span class="nc" id="L97">        return products.stream().collect(Collectors.groupingBy(ProductDto::getBrand, LinkedHashMap::new, Collectors.toList()));</span>
    }

    @Override
    @Transactional(readOnly = true) // Evaluates health of total inventory against defined thresholds
    public List&lt;ProductStockAlertDto&gt; lowStockSummary(int threshold) {
<span class="fc" id="L103">        return productRepository.findAll().stream().map(p -&gt; {</span>
<span class="fc" id="L104">            int available = p.getStockQty() - getSoldQuantity(p.getProductId());</span>
<span class="pc bpc" id="L105" title="1 of 4 branches missed.">            String severity = (available &lt;= 4) ? &quot;RED&quot; : (available &lt;= 10) ? &quot;ORANGE&quot; : &quot;GREEN&quot;;</span>
<span class="fc" id="L106">            return new ProductStockAlertDto(p.getProductId(), p.getBrand(), p.getName(), available, severity);</span>
<span class="fc" id="L107">        }).collect(Collectors.toList());</span>
    }

    private ProductDto mapToDtoWithStats(Product p) { // Overloaded helper for single-item mapping
<span class="fc" id="L111">        return mapToDtoWithStats(p, getSoldQuantity(p.getProductId()));</span>
    }

    private ProductDto mapToDtoWithStats(Product p, int sold) { // Standardizes DTO creation with inventory math
<span class="fc" id="L115">        ProductDto d = new ProductDto();</span>
<span class="fc" id="L116">        d.setProductId(p.getProductId());</span>
<span class="fc" id="L117">        d.setSkuId(p.getSkuId());</span>
<span class="fc" id="L118">        d.setName(p.getName());</span>
<span class="fc" id="L119">        d.setBrand(p.getBrand());</span>
<span class="fc" id="L120">        d.setPrice(p.getPrice());</span>
<span class="fc" id="L121">        d.setStockQty(p.getStockQty());</span>
<span class="fc" id="L122">        d.setVendorId(p.getVendor().getVendorId());</span>
<span class="fc" id="L123">        d.setCategoryId(p.getCategory().getCategoryId());</span>
<span class="fc" id="L124">        d.setSoldQty(sold);</span>
<span class="fc" id="L125">        d.setAvailableQty(Math.max(0, p.getStockQty() - sold));</span>
<span class="fc" id="L126">        return d;</span>
    }

    private int getSoldQuantity(Long id) { // Private utility to isolate sales volume calculation
<span class="fc" id="L130">        return purchaseItemRepository.findByProductProductIdIn(Collections.singletonList(id))</span>
<span class="fc" id="L131">                .stream().mapToInt(PurchaseItem::getQuantity).sum();</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span></div></body></html>